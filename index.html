<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Learning Signals - Transcript Analysis Demo</title>
  <style>
    :root{
      --bg:#0a0e17;
      --card:#141d2e;
      --text:#e9eefc;
      --muted:#98a7c8;
      --border:rgba(255,255,255,.12);
      --accent:#7c5cff;
      --accent2:#2ee59d;
      --accent3:#ff6b9d;
      --shadow:0 20px 60px rgba(0,0,0,.4);
      --radius:20px;
      --sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      --mono: "SF Mono", Monaco, Consolas, monospace;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1400px 900px at 10% 0%, #1a2540 0%, var(--bg) 60%),
        radial-gradient(1000px 800px at 95% 25%, #1d2a42 0%, var(--bg) 65%);
      min-height:100vh;
      padding:24px 0;
    }
    .wrap{max-width:1400px;margin:0 auto;padding:0 24px;}
    
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:32px;
      padding:20px 28px;
      background:linear-gradient(135deg, rgba(124,92,255,.15), rgba(46,229,157,.10));
      border:1px solid var(--border);
      border-radius:var(--radius);
      backdrop-filter:blur(10px);
    }
    .logo h1{font-size:24px;margin:0;letter-spacing:-.3px}
    .logo p{color:var(--muted);font-size:14px;margin-top:4px}
    .badge{
      padding:8px 16px;
      background:rgba(124,92,255,.2);
      border:1px solid rgba(124,92,255,.4);
      border-radius:999px;
      font-size:13px;
      font-weight:600;
      color:#d9d2ff;
    }

    .main{display:grid;grid-template-columns:350px 1fr;gap:24px;margin-bottom:24px}
    @media(max-width:1200px){ .main{grid-template-columns:1fr} }
    
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      padding:24px;
    }

    .section-title{
      font-size:18px;
      margin:0 0 20px;
      padding-bottom:12px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      gap:10px;
    }

    label{
      display:block;
      color:var(--muted);
      font-size:13px;
      font-weight:600;
      margin:16px 0 8px;
      text-transform:uppercase;
      letter-spacing:.5px;
    }

    .btn{
      width:100%;
      padding:14px 20px;
      margin-top:12px;
      border:none;
      border-radius:14px;
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      transition:all .3s;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    .btn-primary{
      background:linear-gradient(135deg, #7c5cff, #9d7cff);
      color:white;
      box-shadow:0 12px 35px rgba(124,92,255,.3);
    }
    .btn-primary:hover:not(:disabled){
      transform:translateY(-2px);
      box-shadow:0 16px 45px rgba(124,92,255,.4);
    }
    .btn-secondary{
      background:linear-gradient(135deg, #2ee59d, #1bb88a);
      color:white;
      box-shadow:0 12px 35px rgba(46,229,157,.3);
    }
    .btn-secondary:hover:not(:disabled){
      transform:translateY(-2px);
      box-shadow:0 16px 45px rgba(46,229,157,.4);
    }
    .btn:disabled{
      opacity:.4;
      cursor:not-allowed;
    }

    .status{
      margin-top:16px;
      padding:12px 16px;
      border-radius:12px;
      background:rgba(46,229,157,.1);
      border:1px solid rgba(46,229,157,.3);
      color:#a3f5d9;
      font-size:13px;
      line-height:1.5;
    }
    .status.error{
      background:rgba(255,107,157,.1);
      border:1px solid rgba(255,107,157,.3);
      color:#ffb8d2;
    }

    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:12px;
      margin-bottom:24px;
    }
    .kpi-box{
      padding:20px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--border);
      border-radius:16px;
      text-align:center;
    }
    .kpi-num{
      font-size:32px;
      font-weight:800;
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .kpi-label{
      color:var(--muted);
      font-size:12px;
      margin-top:8px;
      text-transform:uppercase;
      letter-spacing:.5px;
    }

    .tabs{
      display:flex;
      gap:8px;
      margin-bottom:20px;
      border-bottom:1px solid var(--border);
    }
    .tab{
      padding:10px 20px;
      background:transparent;
      border:none;
      color:var(--muted);
      cursor:pointer;
      border-bottom:2px solid transparent;
      transition:all .2s;
      font-size:14px;
      font-weight:600;
    }
    .tab.active{
      color:var(--text);
      border-bottom-color:var(--accent);
    }
    .tab-content{display:none}
    .tab-content.active{display:block}

    .transcript-list{
      max-height:400px;
      overflow-y:auto;
    }
    .transcript-item{
      padding:14px;
      background:rgba(0,0,0,.2);
      border:1px solid var(--border);
      border-radius:12px;
      margin-bottom:10px;
    }
    .transcript-name{
      font-weight:600;
      font-size:14px;
      color:var(--text);
      margin-bottom:4px;
    }
    .transcript-preview{
      font-size:12px;
      color:var(--muted);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .transcript-meta{
      display:flex;
      justify-content:space-between;
      margin-top:8px;
      font-size:11px;
      color:var(--muted);
    }

    .pattern-card{
      padding:20px;
      background:rgba(0,0,0,.2);
      border:1px solid var(--border);
      border-radius:16px;
      margin-bottom:16px;
    }
    .pattern-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .pattern-title{
      font-size:16px;
      font-weight:700;
      color:var(--accent2);
    }
    .pattern-count{
      font-size:12px;
      color:var(--muted);
      background:rgba(255,255,255,.05);
      padding:4px 10px;
      border-radius:999px;
    }
    .keywords{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin:12px 0;
    }
    .keyword{
      padding:6px 12px;
      background:rgba(124,92,255,.15);
      border:1px solid rgba(124,92,255,.3);
      border-radius:999px;
      font-size:12px;
      font-family:var(--mono);
      color:#c5b3ff;
    }

    .ai-insight{
      margin-top:16px;
      padding:16px;
      background:linear-gradient(135deg, rgba(124,92,255,.1), rgba(46,229,157,.08));
      border-left:3px solid var(--accent);
      border-radius:10px;
    }
    .ai-insight-header{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.5px;
      color:var(--accent);
      font-weight:700;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .ai-insight-content{
      color:var(--text);
      line-height:1.6;
      font-size:14px;
    }

    .quote{
      margin-top:12px;
      padding:14px;
      background:rgba(46,229,157,.08);
      border-left:3px solid var(--accent2);
      border-radius:10px;
      font-size:13px;
      line-height:1.6;
      font-style:italic;
      color:var(--muted);
    }

    .loading{
      text-align:center;
      padding:40px;
      color:var(--muted);
    }
    .spinner{
      border:3px solid rgba(124,92,255,.2);
      border-top:3px solid var(--accent);
      border-radius:50%;
      width:40px;
      height:40px;
      animation:spin 1s linear infinite;
      margin:0 auto 16px;
    }
    @keyframes spin{
      0%{transform:rotate(0deg)}
      100%{transform:rotate(360deg)}
    }

    .empty-state{
      text-align:center;
      padding:60px 20px;
      color:var(--muted);
    }

    .file-drop-zone{
      border:2px dashed var(--border);
      border-radius:12px;
      padding:30px;
      text-align:center;
      margin:16px 0;
      cursor:pointer;
      transition:all .2s;
    }
    .file-drop-zone:hover{
      border-color:var(--accent);
      background:rgba(124,92,255,.05);
    }

    .info-box{
      margin-top:20px;
      padding:16px;
      background:rgba(124,92,255,.1);
      border:1px solid rgba(124,92,255,.25);
      border-radius:14px;
      font-size:13px;
      line-height:1.6;
      color:var(--muted);
    }
    .info-box strong{color:var(--text)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="logo">
        <h1>üéì Learning Signals</h1>
        <p>Educational Transcript Analysis Platform</p>
      </div>
      <div class="badge">Research Demo</div>
    </div>

    <div class="main">
      <!-- Sidebar -->
      <div class="card">
        <h2 class="section-title">üìä Transcript Library</h2>

        <div class="kpi-grid">
          <div class="kpi-box">
            <div class="kpi-num" id="totalTranscripts">0</div>
            <div class="kpi-label">Transcripts</div>
          </div>
          <div class="kpi-box">
            <div class="kpi-num" id="totalWords">0</div>
            <div class="kpi-label">Total Words</div>
          </div>
        </div>

        <button class="btn btn-secondary" id="loadSample">
          üìù Load Sample Data (12 transcripts)
        </button>

        <div style="position:relative;margin:20px 0">
          <div style="text-align:center;color:var(--muted);font-size:13px">or upload CSV</div>
        </div>

        <div class="file-drop-zone" id="dropZone">
          <div style="font-size:32px;margin-bottom:10px">üìÅ</div>
          <div style="font-size:14px;color:var(--text);margin-bottom:6px">Drop CSV file here</div>
          <div style="font-size:12px;color:var(--muted)">or click to browse</div>
          <input type="file" id="fileInput" accept=".csv" style="display:none">
        </div>

        <div class="transcript-list" id="transcriptList">
          <div class="empty-state" style="padding:30px 10px">
            <div style="font-size:32px;margin-bottom:8px">üìÑ</div>
            <p style="font-size:13px">No transcripts loaded</p>
          </div>
        </div>

        <button class="btn btn-primary" id="analyzeBtn" disabled style="margin-top:16px">
          üöÄ Analyze with AI
        </button>

        <div class="status" id="status">
          Ready to analyze learning data
        </div>

        <div class="info-box">
          <strong>üí° How it works:</strong><br>
          1. TF-IDF vectorization<br>
          2. K-means clustering<br>
          3. AI interpretation (Claude)<br>
          4. Human validation
        </div>
      </div>

      <!-- Main Content -->
      <div class="card">
        <div class="tabs">
          <button class="tab active" data-tab="analysis">Analysis Results</button>
          <button class="tab" data-tab="architecture">Production Architecture</button>
        </div>

        <div class="tab-content active" id="tab-analysis">
          <div id="results">
            <div class="empty-state">
              <div style="font-size:48px;margin-bottom:16px">üìà</div>
              <p>Load transcripts and click "Analyze with AI" to discover patterns</p>
            </div>
          </div>
        </div>

        <div class="tab-content" id="tab-architecture">
          <div style="padding:20px">
            <h3 style="font-size:20px;margin-bottom:20px;color:var(--accent2)">Scaling to 1,000+ Transcripts</h3>
            
            <div style="background:rgba(0,0,0,.3);padding:20px;border-radius:14px;margin-bottom:20px;font-family:var(--mono);font-size:13px;color:var(--muted);line-height:2">
Voice/Data Input ‚Üí Batch Ingestion ‚Üí ETL Pipeline<br>
&nbsp;&nbsp;&nbsp;&nbsp;‚Üì&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Üì<br>
Transcription&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PostgreSQL + Vector DB<br>
&nbsp;&nbsp;&nbsp;&nbsp;‚Üì&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Üì<br>
Processing Queue&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Background Jobs (Celery)<br>
&nbsp;&nbsp;&nbsp;&nbsp;‚Üì&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Üì<br>
LLM Analysis&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Claude/GPT-4<br>
&nbsp;&nbsp;&nbsp;&nbsp;‚Üì&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Üì<br>
Dashboard Output&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Research Interface
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
              <div style="padding:16px;background:rgba(0,0,0,.2);border:1px solid var(--border);border-radius:12px">
                <h4 style="color:var(--accent);font-size:14px;margin-bottom:10px">üóÑÔ∏è Data Layer</h4>
                <ul style="color:var(--muted);font-size:13px;line-height:1.8;list-style:none;padding:0">
                  <li>‚Ä¢ PostgreSQL for metadata</li>
                  <li>‚Ä¢ Pinecone for embeddings</li>
                  <li>‚Ä¢ Redis for caching</li>
                  <li>‚Ä¢ S3 for raw files</li>
                </ul>
              </div>
              <div style="padding:16px;background:rgba(0,0,0,.2);border:1px solid var(--border);border-radius:12px">
                <h4 style="color:var(--accent);font-size:14px;margin-bottom:10px">‚öôÔ∏è Processing</h4>
                <ul style="color:var(--muted);font-size:13px;line-height:1.8;list-style:none;padding:0">
                  <li>‚Ä¢ Python FastAPI backend</li>
                  <li>‚Ä¢ Celery task queue</li>
                  <li>‚Ä¢ Batch LLM calls</li>
                  <li>‚Ä¢ Async processing</li>
                </ul>
              </div>
            </div>

            <div style="padding:16px;background:rgba(0,0,0,.2);border:1px solid var(--border);border-radius:12px">
              <h4 style="color:var(--accent2);font-size:14px;margin-bottom:10px">üìä Scale Estimates (1,200 transcripts)</h4>
              <div style="color:var(--muted);font-size:13px;line-height:1.8">
                <strong style="color:var(--text)">Performance:</strong><br>
                ‚Ä¢ Ingestion: ~2-3 hours for full batch<br>
                ‚Ä¢ Embeddings: ~1-2 hours (OpenAI ada-002)<br>
                ‚Ä¢ LLM Analysis: ~3-4 hours (batch processing)<br>
                ‚Ä¢ Query Speed: <2s per search<br><br>
                <strong style="color:var(--text)">Costs:</strong><br>
                ‚Ä¢ LLM Processing: ~$150-200 (Claude Sonnet)<br>
                ‚Ä¢ Embeddings: ~$5-10 (OpenAI)<br>
                ‚Ä¢ Vector DB: ~$70/month (Pinecone)<br>
                ‚Ä¢ Infrastructure: ~$50/month (AWS)<br><br>
                <strong style="color:var(--text)">Timeline:</strong><br>
                ‚Ä¢ Week 1-2: Backend API + database setup<br>
                ‚Ä¢ Week 3-4: Integration + testing<br>
                ‚Ä¢ Week 5: Production deployment
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// Sample data
const SAMPLE_DATA = [
  { id: 1, name: "Student_001", text: "The collaborative project really helped me understand how theoretical concepts apply in practice. Working with my peers exposed me to different perspectives I hadn't considered." },
  { id: 2, name: "Student_002", text: "I struggled initially with the complex readings but office hours clarified key concepts. The instructor's examples bridged theory and application effectively." },
  { id: 3, name: "Student_003", text: "Group discussions were transformative - hearing classmates' interpretations deepened my understanding. I learned to articulate my thinking more clearly through peer dialogue." },
  { id: 4, name: "Student_004", text: "The hands-on activities made abstract concepts concrete. I appreciated learning by doing rather than just memorizing definitions from lectures." },
  { id: 5, name: "Student_005", text: "Time management was my biggest challenge. Balancing readings, assignments, and projects taught me to prioritize and plan better for future courses." },
  { id: 6, name: "Student_006", text: "The iterative feedback process improved my work significantly. Revising based on comments helped me develop critical self-assessment skills." },
  { id: 7, name: "Student_007", text: "Connecting course material to real-world applications motivated me. Case studies showed relevance beyond the classroom which increased my engagement." },
  { id: 8, name: "Student_008", text: "Peer teaching moments were valuable - explaining concepts to classmates reinforced my own understanding and revealed gaps in my knowledge." },
  { id: 9, name: "Student_009", text: "The diverse examples from different industries helped contextualize theories. Seeing multiple applications made the content feel more accessible and relevant." },
  { id: 10, name: "Student_010", text: "Reflective writing assignments pushed me to think metacognitively about my learning process. This self-awareness will benefit my future academic work." },
  { id: 11, name: "Student_011", text: "I found the asynchronous discussion forums helpful for processing ideas at my own pace before contributing. This format accommodated different thinking styles." },
  { id: 12, name: "Student_012", text: "Guest speakers brought practitioner perspectives that enriched the academic content. Their stories illustrated how concepts translate to professional contexts." }
];

const state = { transcripts: [] };

function updateDashboard() {
  document.getElementById('totalTranscripts').textContent = state.transcripts.length;
  const totalWords = state.transcripts.reduce((sum, t) => sum + t.text.split(' ').length, 0);
  document.getElementById('totalWords').textContent = totalWords.toLocaleString();
  document.getElementById('analyzeBtn').disabled = state.transcripts.length === 0;
  
  renderTranscriptList();
}

function renderTranscriptList() {
  const container = document.getElementById('transcriptList');
  if (state.transcripts.length === 0) {
    container.innerHTML = '<div class="empty-state" style="padding:30px 10px"><div style="font-size:32px;margin-bottom:8px">üìÑ</div><p style="font-size:13px">No transcripts loaded</p></div>';
    return;
  }

  container.innerHTML = state.transcripts.map(t => {
    const preview = t.text.substring(0, 60) + '...';
    const wordCount = t.text.split(' ').length;
    return `
      <div class="transcript-item">
        <div class="transcript-name">${escapeHTML(t.name)}</div>
        <div class="transcript-preview">${escapeHTML(preview)}</div>
        <div class="transcript-meta">
          <span>${wordCount} words</span>
        </div>
      </div>
    `;
  }).join('');
}

// Analysis functions
function cleanText(s) {
  return String(s || "")
    .toLowerCase()
    .replace(/https?:\/\/\S+/g, " ")
    .replace(/[^a-z0-9\s']/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

function tokenize(s) {
  const stop = new Set([
    "the", "a", "an", "and", "or", "but", "if", "then", "else", "when", "while", "to", "of", "in", "on", "for", "with", "as", "at", "by",
    "is", "are", "was", "were", "be", "been", "being", "it", "this", "that", "these", "those", "i", "we", "you", "they", "he", "she", "my",
    "our", "your", "their", "me", "us", "him", "her", "them", "from", "into", "about", "over", "under", "again", "very", "really", "just",
    "so", "because", "can", "could", "should", "would", "will", "did", "do", "does", "done", "than", "too", "also", "not"
  ]);
  return s.split(" ")
    .map(t => t.trim())
    .filter(t => t.length >= 3 && !stop.has(t));
}

function buildVocab(docs) {
  const df = new Map();
  const tdocs = [];
  docs.forEach(d => {
    const toks = tokenize(cleanText(d));
    const uniq = new Set(toks);
    uniq.forEach(t => df.set(t, (df.get(t) || 0) + 1));
    tdocs.push(toks);
  });

  const terms = [...df.entries()]
    .filter(([t, c]) => c >= 1)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 2500)
    .map(([t]) => t);

  const idx = new Map();
  terms.forEach((t, i) => idx.set(t, i));
  return { terms, idx, tdocs };
}

function tfidfMatrix(tdocs, terms, idx) {
  const N = tdocs.length;
  const df = new Array(terms.length).fill(0);

  const tf = tdocs.map(toks => {
    const counts = new Map();
    toks.forEach(t => {
      if (idx.has(t)) counts.set(t, (counts.get(t) || 0) + 1);
    });
    counts.forEach((v, t) => { df[idx.get(t)] += 1; });
    return counts;
  });

  const idf = df.map(dfi => Math.log((N + 1) / (dfi + 1)) + 1);

  const X = tf.map(counts => {
    const vec = new Array(terms.length).fill(0);
    counts.forEach((v, t) => {
      const j = idx.get(t);
      vec[j] = (v) * idf[j];
    });
    const norm = Math.sqrt(vec.reduce((s, x) => s + x * x, 0)) || 1;
    for (let j = 0; j < vec.length; j++) vec[j] /= norm;
    return vec;
  });

  return { X };
}

function cosineDistance(a, b) {
  let dot = 0;
  for (let i = 0; i < a.length; i++) dot += a[i] * b[i];
  return 1 - dot;
}

function kmeans(X, k, iters = 25) {
  const n = X.length;
  const d = X[0].length;

  const idxs = [...Array(n).keys()];
  for (let i = idxs.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [idxs[i], idxs[j]] = [idxs[j], idxs[i]];
  }
  let centers = idxs.slice(0, k).map(i => X[i].slice());
  let labels = new Array(n).fill(0);

  for (let it = 0; it < iters; it++) {
    let changed = false;
    for (let i = 0; i < n; i++) {
      let best = 0, bestDist = Infinity;
      for (let c = 0; c < k; c++) {
        const dist = cosineDistance(X[i], centers[c]);
        if (dist < bestDist) { bestDist = dist; best = c; }
      }
      if (labels[i] !== best) { labels[i] = best; changed = true; }
    }
    const newCenters = Array.from({ length: k }, () => new Array(d).fill(0));
    const counts = new Array(k).fill(0);
    for (let i = 0; i < n; i++) {
      const c = labels[i];
      counts[c] += 1;
      const xi = X[i];
      for (let j = 0; j < d; j++) newCenters[c][j] += xi[j];
    }
    for (let c = 0; c < k; c++) {
      if (counts[c] === 0) continue;
      for (let j = 0; j < d; j++) newCenters[c][j] /= counts[c];
      const norm = Math.sqrt(newCenters[c].reduce((s, x) => s + x * x, 0)) || 1;
      for (let j = 0; j < d; j++) newCenters[c][j] /= norm;
    }
    centers = newCenters;
    if (!changed) break;
  }
  return { labels, centers };
}

function topKeywordsForCluster(centers, terms, topN) {
  return centers.map(center => {
    const pairs = center.map((w, i) => [i, w]);
    pairs.sort((a, b) => b[1] - a[1]);
    return pairs.slice(0, topN).map(([i]) => terms[i]);
  });
}

function representativeQuotes(X, labels, centers, texts, perCluster) {
  const reps = [];
  for (let c = 0; c < centers.length; c++) {
    const items = [];
    for (let i = 0; i < X.length; i++) {
      if (labels[i] !== c) continue;
      const dist = cosineDistance(X[i], centers[c]);
      items.push([dist, i]);
    }
    items.sort((a, b) => a[0] - b[0]);
    reps[c] = items.slice(0, perCluster).map(([, i]) => texts[i]);
  }
  return reps;
}

async function generateInsights(keywords, quotes) {
  const insights = [];
  
  for (let i = 0; i < keywords.length; i++) {
    const kw = keywords[i];
    const q = quotes[i] || [];
    
    const prompt = `You are an educational researcher analyzing learning data.

Pattern ${i + 1} keywords: ${kw.join(", ")}
Sample quotes:
${q.map((qt, idx) => `${idx + 1}. "${qt}"`).join("\n")}

Provide a brief 2-3 sentence interpretation of the educational theme this pattern reveals.`;

    try {
      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1000,
          messages: [{ role: "user", content: prompt }]
        })
      });

      const data = await response.json();
      const text = data.content?.map(c => c.text || "").join("") || "Analysis unavailable";
      insights.push(text.trim());
    } catch (err) {
      console.error("AI error:", err);
      insights.push("Pattern analysis: " + kw.slice(0, 3).join(", ") + " and related themes");
    }
  }
  
  return insights;
}

function escapeHTML(str) {
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;");
}

async function runAnalysis() {
  const texts = state.transcripts.map(t => t.text);
  const k = Math.min(3, Math.max(2, Math.floor(texts.length / 4)));

  const container = document.getElementById('results');
  container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyzing ' + texts.length + ' transcripts...</p></div>';

  try {
    const { terms, idx, tdocs } = buildVocab(texts);
    if (terms.length < 5) {
      container.innerHTML = '<div class="empty-state"><p>Not enough text data</p></div>';
      return;
    }

    const { X } = tfidfMatrix(tdocs, terms, idx);
    const { labels, centers } = kmeans(X, k, 25);
    const keywords = topKeywordsForCluster(centers, terms, 6);
    const reps = representativeQuotes(X, labels, centers, texts, 2);

    const insights = await generateInsights(keywords, reps);

    const counts = labels.reduce((acc, l) => {
      acc[l] = (acc[l] || 0) + 1;
      return acc;
    }, {});

    let html = `
      <div class="kpi-grid" style="grid-template-columns:repeat(4, 1fr);margin-bottom:24px">
        <div class="kpi-box">
          <div class="kpi-num">${texts.length}</div>
          <div class="kpi-label">Transcripts</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-num">${k}</div>
          <div class="kpi-label">Patterns</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-num">${keywords[0].length * k}</div>
          <div class="kpi-label">Keywords</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-num">${texts.reduce((s, t) => s + t.split(' ').length, 0).toLocaleString()}</div>
          <div class="kpi-label">Words</div>
        </div>
      </div>
    `;

    for (let c = 0; c < k; c++) {
      html += `
        <div class="pattern-card">
          <div class="pattern-header">
            <div class="pattern-title">Pattern ${c + 1}</div>
            <div class="pattern-count">${counts[c] || 0} transcripts</div>
          </div>
          
          <div class="keywords">
            ${keywords[c].map(kw => `<span class="keyword">${escapeHTML(kw)}</span>`).join("")}
          </div>

          <div class="ai-insight">
            <div class="ai-insight-header">
              <span>‚ú®</span> AI Interpretation
            </div>
            <div class="ai-insight-content">${escapeHTML(insights[c])}</div>
          </div>

          ${(reps[c] || []).map(q => `
            <div class="quote">"${escapeHTML(q)}"</div>
          `).join("")}
        </div>
      `;
    }

    container.innerHTML = html;
    document.getElementById('status').textContent = '‚úì Analysis complete!';
  } catch (err) {
    console.error(err);
    container.innerHTML = '<div class="empty-state"><p>Analysis error. Try again.</p></div>';
    document.getElementById('status').textContent = 'Error during analysis';
    document.getElementById('status').classList.add('error');
  }
}

// Event listeners
document.getElementById('loadSample').addEventListener('click', () => {
  state.transcripts = [...SAMPLE_DATA];
  updateDashboard();
  document.getElementById('status').textContent = 'Loaded 12 sample transcripts. Ready to analyze!';
});

document.getElementById('dropZone').addEventListener('click', () => {
  document.getElementById('fileInput').click();
});

document.getElementById('fileInput').addEventListener('change', async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  
  const text = await file.text();
  const rows = text.split('\n').filter(l => l.trim());
  
  if (rows.length > 1) {
    const headers = rows[0].split(',');
    const textColIdx = headers.findIndex(h => h.toLowerCase().includes('text') || h.toLowerCase().includes('reflection'));
    
    if (textColIdx >= 0) {
      state.transcripts = rows.slice(1).map((row, idx) => {
        const cols = row.split(',');
        return {
          id: idx + 1,
          name: `Row_${idx + 1}`,
          text: cols[textColIdx] || ""
        };
      }).filter(t => t.text.trim());
      
      updateDashboard();
      document.getElementById('status').textContent = `Loaded ${state.transcripts.length} transcripts from CSV`;
    }
  }
});

document.getElementById('analyzeBtn').addEventListener('click', runAnalysis);

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    tab.classList.add('active');
    const target = tab.dataset.tab;
    document.getElementById(`tab-${target}`).classList.add('active');
  });
});

updateDashboard();
</script>
</body>
</html>
