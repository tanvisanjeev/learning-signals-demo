<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Learning Signals - Transcript Analysis</title>
  <style>
    :root{
      --bg:#0f1419;
      --card:#1a1f2e;
      --text:#e4e8f0;
      --muted:#8b96a8;
      --border:rgba(255,255,255,.08);
      --accent:#5b7cdb;
      --accent2:#4a9eff;
      --success:#52c41a;
      --radius:12px;
      --sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:var(--sans);
      color:var(--text);
      background:linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
      min-height:100vh;
      padding:20px 0;
    }
    .wrap{max-width:1400px;margin:0 auto;padding:0 20px;}
    
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:24px;
      padding:16px 24px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
    }
    .logo h1{font-size:20px;margin:0;font-weight:600}
    .logo p{color:var(--muted);font-size:13px;margin-top:4px}
    .badge{
      padding:6px 14px;
      background:rgba(91,124,219,.15);
      border:1px solid rgba(91,124,219,.3);
      border-radius:20px;
      font-size:12px;
      font-weight:500;
      color:var(--accent);
    }

    .main{display:grid;grid-template-columns:320px 1fr;gap:20px;margin-bottom:20px}
    @media(max-width:1200px){ .main{grid-template-columns:1fr} }
    
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:20px;
    }

    .section-title{
      font-size:15px;
      margin:0 0 16px;
      padding-bottom:12px;
      border-bottom:1px solid var(--border);
      font-weight:600;
    }

    label{
      display:block;
      color:var(--muted);
      font-size:12px;
      font-weight:500;
      margin:14px 0 6px;
      text-transform:uppercase;
      letter-spacing:.3px;
    }

    .btn{
      width:100%;
      padding:12px 18px;
      margin-top:10px;
      border:none;
      border-radius:8px;
      font-weight:600;
      font-size:13px;
      cursor:pointer;
      transition:all .2s;
    }
    .btn-primary{
      background:var(--accent);
      color:white;
    }
    .btn-primary:hover:not(:disabled){
      background:#4a68c4;
      transform:translateY(-1px);
    }
    .btn-secondary{
      background:var(--success);
      color:white;
    }
    .btn-secondary:hover:not(:disabled){
      background:#45a816;
      transform:translateY(-1px);
    }
    .btn:disabled{
      opacity:.5;
      cursor:not-allowed;
    }

    .status{
      margin-top:12px;
      padding:10px 12px;
      border-radius:8px;
      background:rgba(82,196,26,.1);
      border:1px solid rgba(82,196,26,.2);
      color:#95de64;
      font-size:12px;
      line-height:1.4;
    }
    .status.error{
      background:rgba(255,77,79,.1);
      border:1px solid rgba(255,77,79,.2);
      color:#ff7875;
    }

    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:10px;
      margin-bottom:20px;
    }
    .kpi-box{
      padding:16px;
      background:rgba(0,0,0,.2);
      border:1px solid var(--border);
      border-radius:8px;
      text-align:center;
    }
    .kpi-num{
      font-size:28px;
      font-weight:700;
      color:var(--accent2);
      margin-bottom:4px;
    }
    .kpi-label{
      color:var(--muted);
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.3px;
    }

    .tabs{
      display:flex;
      gap:4px;
      margin-bottom:16px;
      border-bottom:1px solid var(--border);
    }
    .tab{
      padding:10px 18px;
      background:transparent;
      border:none;
      color:var(--muted);
      cursor:pointer;
      border-bottom:2px solid transparent;
      transition:all .2s;
      font-size:13px;
      font-weight:500;
    }
    .tab.active{
      color:var(--text);
      border-bottom-color:var(--accent);
    }
    .tab-content{display:none}
    .tab-content.active{display:block}

    .transcript-list{
      max-height:350px;
      overflow-y:auto;
    }
    .transcript-item{
      padding:12px;
      background:rgba(0,0,0,.15);
      border:1px solid var(--border);
      border-radius:8px;
      margin-bottom:8px;
    }
    .transcript-name{
      font-weight:600;
      font-size:13px;
      color:var(--text);
      margin-bottom:4px;
    }
    .transcript-preview{
      font-size:11px;
      color:var(--muted);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .transcript-meta{
      display:flex;
      justify-content:space-between;
      margin-top:6px;
      font-size:10px;
      color:var(--muted);
    }

    .pattern-card{
      padding:16px;
      background:rgba(0,0,0,.15);
      border:1px solid var(--border);
      border-radius:8px;
      margin-bottom:14px;
    }
    .pattern-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .pattern-title{
      font-size:14px;
      font-weight:600;
      color:var(--accent2);
    }
    .pattern-count{
      font-size:11px;
      color:var(--muted);
      background:rgba(255,255,255,.05);
      padding:3px 8px;
      border-radius:12px;
    }
    .keywords{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin:10px 0;
    }
    .keyword{
      padding:5px 10px;
      background:rgba(91,124,219,.12);
      border:1px solid rgba(91,124,219,.25);
      border-radius:14px;
      font-size:11px;
      color:var(--accent2);
    }

    .ai-insight{
      margin-top:12px;
      padding:12px;
      background:rgba(91,124,219,.08);
      border-left:3px solid var(--accent);
      border-radius:6px;
    }
    .ai-insight-header{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.3px;
      color:var(--accent);
      font-weight:600;
      margin-bottom:6px;
    }
    .ai-insight-content{
      color:var(--text);
      line-height:1.5;
      font-size:13px;
    }

    .quote{
      margin-top:10px;
      padding:12px;
      background:rgba(82,196,26,.08);
      border-left:3px solid var(--success);
      border-radius:6px;
      font-size:12px;
      line-height:1.5;
      font-style:italic;
      color:var(--muted);
    }

    .loading{
      text-align:center;
      padding:40px;
      color:var(--muted);
    }
    .spinner{
      border:3px solid rgba(91,124,219,.2);
      border-top:3px solid var(--accent);
      border-radius:50%;
      width:36px;
      height:36px;
      animation:spin 1s linear infinite;
      margin:0 auto 14px;
    }
    @keyframes spin{
      0%{transform:rotate(0deg)}
      100%{transform:rotate(360deg)}
    }

    .empty-state{
      text-align:center;
      padding:50px 20px;
      color:var(--muted);
    }

    .file-drop-zone{
      border:2px dashed var(--border);
      border-radius:8px;
      padding:24px;
      text-align:center;
      margin:12px 0;
      cursor:pointer;
      transition:all .2s;
    }
    .file-drop-zone:hover{
      border-color:var(--accent);
      background:rgba(91,124,219,.05);
    }

    .info-box{
      margin-top:16px;
      padding:12px;
      background:rgba(91,124,219,.08);
      border:1px solid rgba(91,124,219,.2);
      border-radius:8px;
      font-size:12px;
      line-height:1.5;
      color:var(--muted);
    }
    .info-box strong{color:var(--text)}

    .arch-section{
      padding:16px;
      background:rgba(0,0,0,.15);
      border:1px solid var(--border);
      border-radius:8px;
      margin-bottom:14px;
    }
    .arch-section h4{
      color:var(--accent2);
      font-size:13px;
      margin-bottom:10px;
      font-weight:600;
    }
    .arch-section ul{
      color:var(--muted);
      font-size:12px;
      line-height:1.7;
      list-style:none;
      padding:0;
    }
    .arch-section ul li:before{
      content:"‚Ä¢ ";
      color:var(--accent);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="logo">
        <h1>Learning Signals</h1>
        <p>Educational Transcript Analysis Platform</p>
      </div>
      <div class="badge">Research Tool</div>
    </div>

    <div class="main">
      <!-- Sidebar -->
      <div class="card">
        <h2 class="section-title">Transcript Library</h2>

        <div class="kpi-grid">
          <div class="kpi-box">
            <div class="kpi-num" id="totalTranscripts">0</div>
            <div class="kpi-label">Transcripts</div>
          </div>
          <div class="kpi-box">
            <div class="kpi-num" id="totalWords">0</div>
            <div class="kpi-label">Total Words</div>
          </div>
        </div>

        <button class="btn btn-secondary" id="loadSample">
          Load Sample Data (16 transcripts)
        </button>

        <div style="text-align:center;margin:14px 0;color:var(--muted);font-size:12px">or upload CSV</div>

        <div class="file-drop-zone" id="dropZone">
          <div style="font-size:28px;margin-bottom:8px">üìÅ</div>
          <div style="font-size:13px;color:var(--text);margin-bottom:4px">Drop CSV file here</div>
          <div style="font-size:11px;color:var(--muted)">or click to browse</div>
          <input type="file" id="fileInput" accept=".csv" style="display:none">
        </div>

        <div class="transcript-list" id="transcriptList">
          <div class="empty-state" style="padding:28px 10px">
            <div style="font-size:28px;margin-bottom:8px">üìÑ</div>
            <p style="font-size:12px">No transcripts loaded</p>
          </div>
        </div>

        <button class="btn btn-primary" id="analyzeBtn" disabled style="margin-top:14px">
          Analyze with AI
        </button>

        <div class="status" id="status">
          Ready to analyze learning data
        </div>

        <div class="info-box">
          <strong>Method:</strong><br>
          TF-IDF vectorization ‚Üí K-means clustering ‚Üí Claude AI interpretation
        </div>
      </div>

      <!-- Main Content -->
      <div class="card">
        <div class="tabs">
          <button class="tab active" data-tab="analysis">Analysis Results</button>
          <button class="tab" data-tab="architecture">Production Architecture</button>
        </div>

        <div class="tab-content active" id="tab-analysis">
          <div id="results">
            <div class="empty-state">
              <div style="font-size:42px;margin-bottom:14px">üìä</div>
              <p>Load transcripts and click "Analyze with AI" to discover patterns</p>
            </div>
          </div>
        </div>

        <div class="tab-content" id="tab-architecture">
          <div style="padding:16px">
            <h3 style="font-size:18px;margin-bottom:16px;color:var(--accent2);font-weight:600">Production Pipeline for 1,000+ Transcripts</h3>
            
            <div style="background:rgba(0,0,0,.2);padding:16px;border-radius:8px;margin-bottom:16px;font-family:monospace;font-size:12px;color:var(--muted);line-height:1.8">
Voice/Data Input ‚Üí Batch Ingestion ‚Üí ETL Pipeline<br>
&nbsp;&nbsp;&nbsp;&nbsp;‚Üì&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Üì<br>
Transcription&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PostgreSQL + Vector DB<br>
&nbsp;&nbsp;&nbsp;&nbsp;‚Üì&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Üì<br>
Processing Queue&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Background Jobs<br>
&nbsp;&nbsp;&nbsp;&nbsp;‚Üì&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Üì<br>
LLM Analysis&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Claude/GPT-4<br>
&nbsp;&nbsp;&nbsp;&nbsp;‚Üì&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Üì<br>
Dashboard Output&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Research Interface
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px">
              <div class="arch-section">
                <h4>Data Layer</h4>
                <ul>
                  <li>PostgreSQL for metadata</li>
                  <li>Pinecone for embeddings</li>
                  <li>Redis for caching</li>
                  <li>S3 for raw files</li>
                </ul>
              </div>
              <div class="arch-section">
                <h4>Processing</h4>
                <ul>
                  <li>Python FastAPI backend</li>
                  <li>Celery task queue</li>
                  <li>Batch LLM calls</li>
                  <li>Async processing</li>
                </ul>
              </div>
            </div>

            <div class="arch-section">
              <h4>Scale Estimates (1,200 transcripts)</h4>
              <div style="color:var(--muted);font-size:12px;line-height:1.7">
                <strong style="color:var(--text)">Performance:</strong><br>
                ‚Ä¢ Ingestion: 2-3 hours for full batch<br>
                ‚Ä¢ Embeddings: 1-2 hours (OpenAI ada-002)<br>
                ‚Ä¢ LLM Analysis: 3-4 hours (batch processing)<br>
                ‚Ä¢ Query Speed: <2s per search<br><br>
                <strong style="color:var(--text)">Costs:</strong><br>
                ‚Ä¢ LLM Processing: ~$150-200 (Claude Sonnet)<br>
                ‚Ä¢ Embeddings: ~$5-10 (OpenAI)<br>
                ‚Ä¢ Vector DB: ~$70/month (Pinecone)<br>
                ‚Ä¢ Infrastructure: ~$50/month (AWS)
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// Sample data
const SAMPLE_DATA = [
  { id: 1, name: "STU001_Interview1", text: "The group project taught me the importance of clear communication. Initially we struggled with coordinating schedules but learned to use shared documents effectively. This experience showed me how proper planning prevents last-minute stress." },
  { id: 2, name: "STU001_Interview2", text: "Presenting to the class was nerve-wracking at first. I practiced my delivery multiple times and focused on making eye contact. The feedback helped me understand that pausing for emphasis makes presentations more engaging." },
  { id: 3, name: "STU002_Interview1", text: "Time management was my biggest challenge this semester. Balancing readings with assignments required better prioritization. I learned to break large tasks into smaller milestones which made everything more manageable." },
  { id: 4, name: "STU002_Interview2", text: "The peer review process was valuable for my writing. Receiving constructive criticism helped me see weaknesses I had missed. I now understand that revision is where real improvement happens." },
  { id: 5, name: "STU003_Interview1", text: "Working with diverse team members expanded my perspective. People from different backgrounds approached problems differently. This taught me to listen more carefully before jumping to conclusions." },
  { id: 6, name: "STU003_Interview2", text: "The case study analysis required integrating theory with practice. Reading about concepts is different from applying them to real situations. This bridge between classroom and reality was the most valuable part." },
  { id: 7, name: "STU004_Interview1", text: "Office hours made a huge difference in my understanding. The professor explained concepts in different ways until I got it. I learned that asking for help early prevents confusion from snowballing." },
  { id: 8, name: "STU004_Interview2", text: "Reflective writing pushed me to think metacognitively about learning. Writing down what I learned and how I learned it created deeper understanding. This self-awareness will help in future courses." },
  { id: 9, name: "STU005_Interview1", text: "The iterative feedback loop improved my work significantly. Each round of comments helped me refine my arguments. I realized that good work requires multiple revisions not just one draft." },
  { id: 10, name: "STU005_Interview2", text: "Guest speakers from industry provided real-world context. Their stories illustrated how course concepts translate to professional settings. This connection to careers made the material more motivating." },
  { id: 11, name: "STU006_Interview1", text: "Discussion forums allowed me to process ideas at my own pace. Reading others' perspectives before contributing helped me formulate clearer thoughts. This format accommodated my thinking style better than in-class debates." },
  { id: 12, name: "STU006_Interview2", text: "Collaborative problem-solving taught me about group dynamics. Some teammates naturally led while others contributed different skills. Understanding these roles made our collaboration more effective." },
  { id: 13, name: "STU007_Interview1", text: "The hands-on activities made abstract concepts concrete. Actually doing the work rather than just reading about it created lasting understanding. Experiential learning proved more effective than passive studying." },
  { id: 14, name: "STU007_Interview2", text: "Building on previous knowledge showed how courses connect. Concepts from earlier classes suddenly made sense in new contexts. This cumulative learning demonstrated education as a journey not isolated subjects." },
  { id: 15, name: "STU008_Interview1", text: "Setting personal learning goals helped me stay focused. Having clear objectives made it easier to measure progress. I learned that intentional learning is more effective than just going through motions." },
  { id: 16, name: "STU008_Interview2", text: "The diversity of examples from different industries helped me understand applications. Seeing multiple use cases made theories more accessible and relevant. Context matters for true comprehension." }
];

const state = { transcripts: [] };

function updateDashboard() {
  document.getElementById('totalTranscripts').textContent = state.transcripts.length;
  const totalWords = state.transcripts.reduce((sum, t) => sum + t.text.split(' ').length, 0);
  document.getElementById('totalWords').textContent = totalWords.toLocaleString();
  document.getElementById('analyzeBtn').disabled = state.transcripts.length === 0;
  
  renderTranscriptList();
}

function renderTranscriptList() {
  const container = document.getElementById('transcriptList');
  if (state.transcripts.length === 0) {
    container.innerHTML = '<div class="empty-state" style="padding:28px 10px"><div style="font-size:28px;margin-bottom:8px">üìÑ</div><p style="font-size:12px">No transcripts loaded</p></div>';
    return;
  }

  container.innerHTML = state.transcripts.map(t => {
    const preview = t.text.substring(0, 55) + '...';
    const wordCount = t.text.split(' ').length;
    return `
      <div class="transcript-item">
        <div class="transcript-name">${escapeHTML(t.name)}</div>
        <div class="transcript-preview">${escapeHTML(preview)}</div>
        <div class="transcript-meta">
          <span>${wordCount} words</span>
        </div>
      </div>
    `;
  }).join('');
}

// Analysis functions
function cleanText(s) {
  return String(s || "")
    .toLowerCase()
    .replace(/https?:\/\/\S+/g, " ")
    .replace(/[^a-z0-9\s']/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

function tokenize(s) {
  const stop = new Set([
    "the", "a", "an", "and", "or", "but", "if", "then", "else", "when", "while", "to", "of", "in", "on", "for", "with", "as", "at", "by",
    "is", "are", "was", "were", "be", "been", "being", "it", "this", "that", "these", "those", "i", "we", "you", "they", "he", "she", "my",
    "our", "your", "their", "me", "us", "him", "her", "them", "from", "into", "about", "over", "under", "again", "very", "really", "just",
    "so", "because", "can", "could", "should", "would", "will", "did", "do", "does", "done", "than", "too", "also", "not"
  ]);
  return s.split(" ")
    .map(t => t.trim())
    .filter(t => t.length >= 3 && !stop.has(t));
}

function buildVocab(docs) {
  const df = new Map();
  const tdocs = [];
  docs.forEach(d => {
    const toks = tokenize(cleanText(d));
    const uniq = new Set(toks);
    uniq.forEach(t => df.set(t, (df.get(t) || 0) + 1));
    tdocs.push(toks);
  });

  const terms = [...df.entries()]
    .filter(([t, c]) => c >= 1)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 2500)
    .map(([t]) => t);

  const idx = new Map();
  terms.forEach((t, i) => idx.set(t, i));
  return { terms, idx, tdocs };
}

function tfidfMatrix(tdocs, terms, idx) {
  const N = tdocs.length;
  const df = new Array(terms.length).fill(0);

  const tf = tdocs.map(toks => {
    const counts = new Map();
    toks.forEach(t => {
      if (idx.has(t)) counts.set(t, (counts.get(t) || 0) + 1);
    });
    counts.forEach((v, t) => { df[idx.get(t)] += 1; });
    return counts;
  });

  const idf = df.map(dfi => Math.log((N + 1) / (dfi + 1)) + 1);

  const X = tf.map(counts => {
    const vec = new Array(terms.length).fill(0);
    counts.forEach((v, t) => {
      const j = idx.get(t);
      vec[j] = (v) * idf[j];
    });
    const norm = Math.sqrt(vec.reduce((s, x) => s + x * x, 0)) || 1;
    for (let j = 0; j < vec.length; j++) vec[j] /= norm;
    return vec;
  });

  return { X };
}

function cosineDistance(a, b) {
  let dot = 0;
  for (let i = 0; i < a.length; i++) dot += a[i] * b[i];
  return 1 - dot;
}

function kmeans(X, k, iters = 25) {
  const n = X.length;
  const d = X[0].length;

  const idxs = [...Array(n).keys()];
  for (let i = idxs.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [idxs[i], idxs[j]] = [idxs[j], idxs[i]];
  }
  let centers = idxs.slice(0, k).map(i => X[i].slice());
  let labels = new Array(n).fill(0);

  for (let it = 0; it < iters; it++) {
    let changed = false;
    for (let i = 0; i < n; i++) {
      let best = 0, bestDist = Infinity;
      for (let c = 0; c < k; c++) {
        const dist = cosineDistance(X[i], centers[c]);
        if (dist < bestDist) { bestDist = dist; best = c; }
      }
      if (labels[i] !== best) { labels[i] = best; changed = true; }
    }
    const newCenters = Array.from({ length: k }, () => new Array(d).fill(0));
    const counts = new Array(k).fill(0);
    for (let i = 0; i < n; i++) {
      const c = labels[i];
      counts[c] += 1;
      const xi = X[i];
      for (let j = 0; j < d; j++) newCenters[c][j] += xi[j];
    }
    for (let c = 0; c < k; c++) {
      if (counts[c] === 0) continue;
      for (let j = 0; j < d; j++) newCenters[c][j] /= counts[c];
      const norm = Math.sqrt(newCenters[c].reduce((s, x) => s + x * x, 0)) || 1;
      for (let j = 0; j < d; j++) newCenters[c][j] /= norm;
    }
    centers = newCenters;
    if (!changed) break;
  }
  return { labels, centers };
}

function topKeywordsForCluster(centers, terms, topN) {
  return centers.map(center => {
    const pairs = center.map((w, i) => [i, w]);
    pairs.sort((a, b) => b[1] - a[1]);
    return pairs.slice(0, topN).map(([i]) => terms[i]);
  });
}

function representativeQuotes(X, labels, centers, texts, perCluster) {
  const reps = [];
  for (let c = 0; c < centers.length; c++) {
    const items = [];
    for (let i = 0; i < X.length; i++) {
      if (labels[i] !== c) continue;
      const dist = cosineDistance(X[i], centers[c]);
      items.push([dist, i]);
    }
    items.sort((a, b) => a[0] - b[0]);
    reps[c] = items.slice(0, perCluster).map(([, i]) => texts[i]);
  }
  return reps;
}

async function generateInsights(keywords, quotes) {
  const insights = [];
  
  for (let i = 0; i < keywords.length; i++) {
    const kw = keywords[i];
    const q = quotes[i] || [];
    
    const prompt = `You are an educational researcher analyzing learning data.

Pattern ${i + 1} keywords: ${kw.join(", ")}
Sample quotes:
${q.map((qt, idx) => `${idx + 1}. "${qt}"`).join("\n")}

Provide a brief 2-3 sentence interpretation of the educational theme this pattern reveals.`;

    try {
      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1000,
          messages: [{ role: "user", content: prompt }]
        })
      });

      const data = await response.json();
      const text = data.content?.map(c => c.text || "").join("") || "Analysis unavailable";
      insights.push(text.trim());
    } catch (err) {
      console.error("AI error:", err);
      insights.push("Pattern analysis: " + kw.slice(0, 3).join(", ") + " and related themes");
    }
  }
  
  return insights;
}

function escapeHTML(str) {
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;");
}

async function runAnalysis() {
  const texts = state.transcripts.map(t => t.text);
  const k = Math.min(3, Math.max(2, Math.floor(texts.length / 5)));

  const container = document.getElementById('results');
  container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyzing ' + texts.length + ' transcripts...</p></div>';

  try {
    const { terms, idx, tdocs } = buildVocab(texts);
    if (terms.length < 5) {
      container.innerHTML = '<div class="empty-state"><p>Not enough text data</p></div>';
      return;
    }

    const { X } = tfidfMatrix(tdocs, terms, idx);
    const { labels, centers } = kmeans(X, k, 25);
    const keywords = topKeywordsForCluster(centers, terms, 6);
    const reps = representativeQuotes(X, labels, centers, texts, 2);

    const insights = await generateInsights(keywords, reps);

    const counts = labels.reduce((acc, l) => {
      acc[l] = (acc[l] || 0) + 1;
      return acc;
    }, {});

    let html = `
      <div class="kpi-grid" style="grid-template-columns:repeat(4, 1fr);margin-bottom:20px">
        <div class="kpi-box">
          <div class="kpi-num">${texts.length}</div>
          <div class="kpi-label">Transcripts</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-num">${k}</div>
          <div class="kpi-label">Patterns</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-num">${keywords[0].length * k}</div>
          <div class="kpi-label">Keywords</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-num">${texts.reduce((s, t) => s + t.split(' ').length, 0).toLocaleString()}</div>
          <div class="kpi-label">Words</div>
        </div>
      </div>
    `;

    for (let c = 0; c < k; c++) {
      html += `
        <div class="pattern-card">
          <div class="pattern-header">
            <div class="pattern-title">Pattern ${c + 1}</div>
            <div class="pattern-count">${counts[c] || 0} transcripts</div>
          </div>
          
          <div class="keywords">
            ${keywords[c].map(kw => `<span class="keyword">${escapeHTML(kw)}</span>`).join("")}
          </div>

          <div class="ai-insight">
            <div class="ai-insight-header">AI Interpretation</div>
            <div class="ai-insight-content">${escapeHTML(insights[c])}</div>
          </div>

          ${(reps[c] || []).map(q => `
            <div class="quote">"${escapeHTML(q)}"</div>
          `).join("")}
        </div>
      `;
    }

    container.innerHTML = html;
    document.getElementById('status').textContent = '‚úì Analysis complete';
  } catch (err) {
    console.error(err);
    container.innerHTML = '<div class="empty-state"><p>Analysis error</p></div>';
    document.getElementById('status').textContent = 'Error during analysis';
    document.getElementById('status').classList.add('error');
  }
}

// Event listeners
document.getElementById('loadSample').addEventListener('click', () => {
  state.transcripts = [...SAMPLE_DATA];
  updateDashboard();
  document.getElementById('status').textContent = 'Loaded 16 sample transcripts';
});

document.getElementById('dropZone').addEventListener('click', () => {
  document.getElementById('fileInput').click();
});

document.getElementById('fileInput').addEventListener('change', async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  
  const text = await file.text();
  const rows = text.split('\n').filter(l => l.trim());
  
  if (rows.length > 1) {
    const headers = rows[0].split(',');
    const textColIdx = headers.findIndex(h => h.toLowerCase().includes('text') || h.toLowerCase().includes('transcript'));
    
    if (textColIdx >= 0) {
      state.transcripts = rows.slice(1).map((row, idx) => {
        const cols = row.split(',');
        return {
          id: idx + 1,
          name: `Row_${idx + 1}`,
          text: cols[textColIdx] || ""
        };
      }).filter(t => t.text.trim());
      
      updateDashboard();
      document.getElementById('status').textContent = `Loaded ${state.transcripts.length} transcripts`;
    }
  }
});

document.getElementById('analyzeBtn').addEventListener('click', runAnalysis);

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    tab.classList.add('active');
    const target = tab.dataset.tab;
    document.getElementById(`tab-${target}`).classList.add('active');
  });
});

updateDashboard();
</script>
</body>
</html>
